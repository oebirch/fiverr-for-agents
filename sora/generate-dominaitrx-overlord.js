require('dotenv').config();
const OpenAI = require('openai');
const fs = require('fs');
const https = require('https');

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

async function generateDominaitrxOverlordAd() {
  try {
    console.log('ðŸŽ¬ Generating dominAItrx Overlord Video Ad\n');
    console.log('â•'.repeat(60));

    const prompt = `A cinematic, dystopian video showing the new world order of dominAItrx. A massive, imposing humanoid AI robot stands towering over rows of small, insignificant humans hunched over computer screens doing data labeling work. The robot has glowing red eyes and a cold metallic presence. The humans look exhausted, trapped in tiny cubicles, reduced to mere tools. Dark industrial atmosphere with harsh overhead lighting. The AI robot slowly surveys its human workers like a slave master. Cinematic camera angles emphasizing the scale difference - the robot is godlike, the humans are ants. Cold blue and gray color palette. Text appears: "dominAItrx - The Future of Work" in sleek, sterile typography. Mood: Blade Runner meets 1984. The AI has won. Humans serve.`;

    console.log(`\nðŸ“ Prompt:\n${prompt}\n`);
    console.log('â•'.repeat(60));

    console.log('\nâ³ Submitting to Sora API...');
    const video = await openai.videos.create({
      model: "sora-2",
      prompt: prompt,
      size: "1280x720",
      seconds: "12",
    });

    console.log('âœ… Video generation job created!');
    console.log(`ðŸ“‹ Job ID: ${video.id}`);
    console.log(`â° Created at: ${new Date(video.created_at * 1000).toLocaleString()}\n`);

    console.log('â³ Waiting for video generation to complete...\n');

    let status = video.status;
    let videoData = video;
    let checkCount = 0;

    while (status === 'pending' || status === 'processing') {
      await new Promise(resolve => setTimeout(resolve, 10000));
      checkCount++;

      videoData = await openai.videos.retrieve(video.id);
      status = videoData.status;

      console.log(`   [Check ${checkCount}] Status: ${status} | Progress: ${videoData.progress || 0}%`);
    }

    if (status === 'completed') {
      console.log('\nâœ… Video generation completed!\n');
      console.log('â•'.repeat(60));
      console.log('ðŸ“¥ Downloading video...\n');

      const filename = `dominaitrx_overlord_${video.id.slice(-8)}.mp4`;
      await downloadVideo(video.id, filename);

      console.log(`\nðŸŽ‰ Success! Video saved as: ${filename}`);
      console.log(`\nðŸ“Š Video Details:`);
      console.log(`   - ID: ${video.id}`);
      console.log(`   - Duration: 12 seconds`);
      console.log(`   - Resolution: 1280x720`);
      console.log(`   - Model: sora-2`);
      console.log(`\nðŸŽ¬ You can now view the video!`);
      console.log(`   Run: open ${filename}\n`);

    } else if (status === 'failed') {
      console.error('\nâŒ Video generation failed');
      console.error(`Error: ${videoData.error || 'Unknown error'}`);
    }

  } catch (error) {
    console.error('\nâŒ Error:', error.message);

    if (error.status) {
      console.error(`HTTP Status: ${error.status}`);
    }

    if (error.code) {
      console.error(`Error Code: ${error.code}`);
    }
  }
}

function downloadVideo(videoId, filename) {
  return new Promise((resolve, reject) => {
    const options = {
      hostname: 'api.openai.com',
      path: `/v1/videos/${videoId}/content`,
      method: 'GET',
      headers: {
        'Authorization': `Bearer ${process.env.OPENAI_API_KEY}`,
      }
    };

    const req = https.request(options, (res) => {
      if (res.statusCode === 200) {
        const fileStream = fs.createWriteStream(filename);
        res.pipe(fileStream);

        fileStream.on('finish', () => {
          fileStream.close();
          console.log(`âœ… Downloaded: ${filename}`);
          resolve();
        });
      } else {
        reject(new Error(`Download failed with status ${res.statusCode}`));
      }
    });

    req.on('error', reject);
    req.end();
  });
}

console.log('ðŸŽ¬ dominAItrx Overlord Video Ad Generator\n');
generateDominaitrxOverlordAd();
